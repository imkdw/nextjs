# 프로덕션 체크리스트

프로덕션 환경에 배포가지 전에 최상의 UX, 성능 및 보안을 위해 구현해야하는 몇가지 최적화 및 패턴이 있음

<br/>

# 자동 최적화

### 서버 컴포넌트

- Next.js는 기본적으로 서버 컴포넌트를 사용함
- 서버 컴포넌트는 서버에서 실행되고 클라이언트에서 렌더링하는데 JS가 필요하지 않음
- 클라이언트 측 JS 번들의 크기에 영향을 미치지 않음
- 또한 상황에 따라서 필요한 경우 클라이언트 컴포넌트 사용이 가능함

<br/>

### 코드 분할

- 서버 컴포넌트르 사용하면 경로별로 자동 코드 분할이 가능함
- 필요한 경우 지연 로딩되는 클라이언트 컴포넌트나 외부 라이브러리 도입도 가능함

<br/>

### 사전 로딩

- 새로운 경로로 연결되는 링크가 유저의 뷰포트 내부에 들어오면 백그라운드에서 경로를 미리 가져옴
- 이렇게 하면 새로운 경로로 거의 즉시 이동이 가능함
- 필요한 경우 prefetch 비활성화도 가능함

<br/>

### 정적 렌더링

- 빌드 시 서버에서 서버 및 클라이언트 컴포넌트를 정적으로 렌더링함
- 렌더링된 결과를 캐싱해서 앱의 성능을 향상시킴
- 필요한 경우 특정 경로에 대해서 동적 렌더링을 선택이 가능함

<br/>

### 캐싱

- 데이터 요청, 서버 및 클라이언트 컴포넌트 렌더링 결과, 정적 에셋 등 을 캐싱해서 백엔드 서비스에 대한 네트워크 요청수를 줄여줌
- 필요한 경우 캐싱 비활성화가 가능함

위 최적화들은 앱의 성능을 개선하고 각 네트워크 요청시 전송되는 데이터의 양과 비용을 줄이는것에 초점을 두고있음

<br/>

# 개발시 해야될꺼

앱을 만들때 최고의 성능과 UX를 위해서 아래처럼 하는걸 권장함

### 라우팅과 렌더링

#### 레이아웃

- 페이지 탐색간 부분 렌더링을 사용하여 레이아웃을 통해 페이지간 UI를 공유함

#### <Link> 컴포넌트

- <Link> 컴포넌트는 클라이언트 사이드에서 페이지를 탐색하거나 prefetch가 필요할 때 사용

#### 에러 핸들링

- 에러 핸들링시 커스텀 에러페이지를 통해서 모든 에러나 404 에러를 보여주는게 좋음

#### 컴포지션 패턴

- 서버 및 클라이언트 컴포넌트에 대해서 권장되는 패턴을 따르고 적절한 `"use client"` 지시어 사용을 통해서 브라우저에서 다운로드하는 JS 번들이 크기가 커지지 않도록 하기

#### 동적 함수

- cookies, headers, searchParams와 같은 동적 함수는 페이지를 동적렌더링으로 만든다는 사실을 유의해야함
- 동적 렌더링 사용이 의도적인지 확인하고 맞는 경우는 Suspense 경계로 감싸주는게 좋음

<br/>

### 데이터 로딩과 캐싱

#### 서버 컴포넌트

- 서버컴포넌트를 통해서 데이터를 가져올 때 얻을 수 있는 이점을 활용하기

#### 라우트 핸들러

- 라우트 핸들러를 통해서 클라이언트 컴포넌트에서 백엔드 리소스에 접근하기
- 하지만 추가적인 서버 요청을 피하기 위해서 서버 컴포넌트에서 라우트 핸들러를 호출하는건 지양하기

#### 스트리밍

- `loading.ts` 와 Suspense를 사용해서 서버에서 클라이언트로 UI를 점진적으로 전송하고 데이터를 가져오는 동안 탐색이 차단되는걸 방지할 수 있음

#### 병렬 데이터 로딩

- 가능한 경우 데이터 로딩을 병렬로 하여 네트워크 워터펄을 줄이기
- 또한 가능한 경우 prefetch도 고려하기

#### 데이터 캐싱

- 데이터 요청이 캐싱되고 있는지 확인하기
- 만약 불필요한 경우 캐싱하지 않는것을 고려

#### 정적 이미지

- `public` 폴더를 통해 정적 이미지를 자동으로 캐싱이 가능함

### UI와 접근성

#### 폼 과 폼 유효성 검사

- 서버 액션을 통해서 서버사이드에서 데이터 제출과 유효성 검사 처리하기

#### 폰트 모듈

- 폰트 파일을 다른 정적 에셋들과 함께 자동으로 호스팅하기
- 외부 네트워크 요청을 줄이고 레이아웃 이동을 줄여주는 폰트 모듈을 사용해서 최적화

#### Image 컴포넌트

- Image 컴포넌트를 사용해서 이미지 최적화하기
- 자동으로 이미지 최적화, 레이아웃 이동 방지, webp or avif 같은 포멧으로 서빙하기

#### Script 컴포넌트

- 외부 스크립트를 Script 태그를 사용해서 최적화하기
- 스크립트 로딩을 자동으로 지연시키고 메인스레드를 차단하지 못하도록 설정하기

#### 린트 사용하기

- 린트를 사용해서 접근성 문제를 초기에 파악하기

<br/>

### 보안

#### Taint

- 데이터 object 및 기타 값에 대해서 taint 하여 클라이언트에 노출되는것을 방지하기

#### 서버 액션

- 유저에게 Server Action을 호출할수 있는 권한이 있는지 확인

#### 환경 변수

- .gitignore에 `.env.*` 추가하기
- 공개된 환경변수에는 `NEXT_PUBLIC_` 키워드 사용하기

#### 콘텐츠 보안 정책

콘텐츠 보안 정책을 추가해서 XSS, Click Hijacking 등 다양한 보안 위협으로 부터 앱을 보호

<br/>

### 메타데이터와 SEO

#### Metadata API

- 메타데이터 API를 사용해서 페이지의 제목, 내용 등 앱을 SEO에 최적화하기

#### 오픈그래프 이미지

- SNS에 링크가 공유되는것을 대비해서 오픈그래프 이미지 생성하기

#### Sitemap과 Robot

- 검색엔진이 페이지를 탐색하고 크롤링 하기위해 sitemap과 robots 파일 만들기

<br/>

# 프로덕션에 배포하기전에 해야될꺼

- `npm run buidl` → `npm run start` 를 통해서 로컬환경에서 테스트하기

### 코어 웹 바이탈

#### LightHouse

- 라이트하우스를 secret 상태로 실행해서 유저가 사이트를 어떻게 경험할지 테스트하고 개선하기
- 이 테스트는 시뮬레이션 이므로 실제 데이터와 함께 병행해서 분석해야함

#### `useReportWebVitals` 훅

- 해당 훅을 사용해서 코어 웹 바이탈을 분석 툴로 전송할 수 있음

<br/>

### 번들 최적화하기

- `@next/bundle-analyzer` 플러그인을 사용해서 JS 번들을 분석하기
- 큰 모듈과 종속성은 웹 성능을 낮추는 원인이 될 수 있음

<br/>

# 배포 이후

- 앱이 배포되는 위치에 따라서 앱의 성능을 모니터링하고 개선하는데 도움이 되는 추가 도구 및 통합 기능을 사용할 수 있음
